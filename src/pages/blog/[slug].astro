---
import { getCollection, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

import TableOfContents from '../../components/TableOfContents.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  // Sort posts by date descending (newest first)
  const sortedPosts = posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

  return sortedPosts.map((post, index) => ({
    params: { slug: post.id },
    props: {
      post,
      // Next post is NEWER (lower index), Prev post is OLDER (higher index)
      nextPost: index > 0 ? sortedPosts[index - 1] : null,
      prevPost: index + 1 < sortedPosts.length ? sortedPosts[index + 1] : null,
    },
  }));
}

type Props = {
  post: CollectionEntry<'blog'>;
  prevPost: CollectionEntry<'blog'> | null;
  nextPost: CollectionEntry<'blog'> | null;
};

const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await render(post);

// Calculate reading time
const wordCount = post.body ? post.body.split(/\s+/g).length : 0;
const readingTime = Math.ceil(wordCount / 200);

// Structured data for SEO
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post.data.title,
  "description": post.data.description,
  "datePublished": post.data.pubDate.toISOString(),
  "author": {
    "@type": "Person",
    "name": post.data.author
  },
  "publisher": {
    "@type": "Person",
    "name": post.data.author
  }
};
---

<Layout
  title={post.data.title}
  description={post.data.description}
  article={true}
  publishedTime={post.data.pubDate.toISOString()}
  ogImage={post.id}
  wide={true}
>
  <!-- Structured Data for SEO -->
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  <!-- Reading Progress Bar -->
  <div class="progress-container">
    <div class="progress-bar" id="scroll-progress"></div>
  </div>

  <article class="post-container">
    <!-- Hero Section -->
    <header class="post-hero">
      <div class="post-meta-top">
        <span class="meta-item date">
          {post.data.pubDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })}
        </span>
        <span class="meta-separator">â€¢</span>
        <span class="meta-item read-time">{readingTime} min read</span>
      </div>

      <h1 class="post-title">{post.data.title}</h1>

      {post.data.tags && post.data.tags.length > 0 && (
        <div class="post-tags">
          {post.data.tags.map((tag: string) => (
            <a href={`/blog?tag=${encodeURIComponent(tag)}`} class="tag">#{tag}</a>
          ))}
        </div>
      )}
    </header>

    <div class="post-layout">
      <!-- Main Content -->
      <div class="post-content-wrapper">
        <div class="post-content">
          <Content />
        </div>

        <!-- Author Bio -->
        <div class="author-bio">
          <div class="bio-avatar">
            <span>SP</span>
          </div>
          <div class="bio-info">
            <h3>Written by {post.data.author}</h3>
            <p>Frontend Engineer passionate about building beautiful, performant web experiences.</p>
          </div>
        </div>

        <!-- Post Navigation -->
        <nav class="post-nav">
          {prevPost ? (
            <a href={`/blog/${prevPost.id}`} class="nav-card prev">
              <span class="nav-label">Previous</span>
              <span class="nav-title">{prevPost.data.title}</span>
            </a>
          ) : (
            <div class="nav-card empty"></div>
          )}

          {nextPost ? (
            <a href={`/blog/${nextPost.id}`} class="nav-card next">
              <span class="nav-label">Next</span>
              <span class="nav-title">{nextPost.data.title}</span>
            </a>
          ) : (
            <div class="nav-card empty"></div>
          )}
        </nav>
      </div>

      <!-- Sidebar TOC -->
      <aside class="post-sidebar">
        <TableOfContents headings={headings} />
      </aside>
    </div>
  </article>
</Layout>

<script>
  // Progress Bar
  window.addEventListener('scroll', () => {
    const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
    const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const scrolled = (winScroll / height) * 100;
    const progressBar = document.getElementById('scroll-progress');
    if (progressBar) {
      progressBar.style.width = scrolled + "%";
    }
  });

  // Copy Code Button
  const copyButtonLabel = "Copy";
  const codeBlocks = Array.from(document.querySelectorAll("pre"));

  for (const codeBlock of codeBlocks) {
    const wrapper = document.createElement("div");
    wrapper.style.position = "relative";

    const copyButton = document.createElement("button");
    copyButton.className = "copy-code";
    copyButton.innerHTML = copyButtonLabel;

    codeBlock.setAttribute("tabindex", "0");
    codeBlock.appendChild(copyButton);

    // wrap codebock with relative parent element
    if (codeBlock.parentNode) {
        codeBlock.parentNode.insertBefore(wrapper, codeBlock);
        wrapper.appendChild(codeBlock);
    }

    copyButton.addEventListener("click", async () => {
      await copyCode(codeBlock, copyButton);
    });
  }

  async function copyCode(block: HTMLPreElement, button: HTMLButtonElement) {
    const code = block.querySelector("code");
    const text = code?.innerText;

    if (text) {
        await navigator.clipboard.writeText(text);
        button.innerText = "Copied!";
        setTimeout(() => {
        button.innerText = copyButtonLabel;
        }, 700);
    }
  }
</script>

<style>
  /* Progress Bar */
  .progress-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: transparent;
    z-index: 1000;
  }

  .progress-bar {
    height: 3px;
    background: var(--color-accent);
    width: 0%;
    transition: width 0.1s ease;
  }

  .post-container {
    max-width: 1440px; /* Increased width for sidebar layout */
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  /* Hero Section */
  .post-hero {
    text-align: center;
    padding: 4rem 0 4rem;
    margin-bottom: 3rem;
    border-bottom: 1px solid var(--color-border);
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
  }

  .post-meta-top {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: 1.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .meta-separator {
    color: var(--color-border);
  }

  .post-title {
    font-size: 3rem;
    line-height: 1.2;
    margin-bottom: 1.5rem;
    color: var(--color-text);
    font-weight: 800;
    letter-spacing: -0.03em;
  }

  .post-tags {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .tag {
    padding: 0.25rem 0.75rem;
    background: transparent;
    color: var(--color-text-secondary);
    border-radius: 100px;
    font-size: 0.8125rem;
    font-weight: 500;
    text-decoration: none;
    border: 1px solid var(--color-border);
    transition: all 0.2s ease;
  }

  .tag:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  /* Layout */
  .post-layout {
    display: grid;
    grid-template-columns: 1fr 250px;
    gap: 3rem;
    align-items: start;
  }

  .post-content-wrapper {
    min-width: 0; /* Prevent overflow */
  }

  .post-sidebar {
    position: sticky;
    top: 2rem;
  }

  /* Content */
  .post-content {
    font-size: 1.125rem;
    line-height: 1.8;
    color: var(--color-text-secondary);
  }

  /* Typography Enhancements */
  .post-content :global(h2) {
    font-size: 1.75rem;
    margin-top: 3.5rem;
    margin-bottom: 1.25rem;
    color: var(--color-text);
    font-weight: 700;
    letter-spacing: -0.02em;
    scroll-margin-top: 2rem;
  }

  .post-content :global(h3) {
    font-size: 1.35rem;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    color: var(--color-text);
    font-weight: 600;
    scroll-margin-top: 2rem;
  }

  .post-content :global(p) {
    margin-bottom: 1.75rem;
  }

  .post-content :global(ul), .post-content :global(ol) {
    margin-bottom: 2rem;
    padding-left: 1.5rem;
  }

  .post-content :global(li) {
    margin-bottom: 0.5rem;
  }

  .post-content :global(blockquote) {
    border-left: 3px solid var(--color-accent);
    background: var(--color-bg-secondary);
    padding: 1.25rem 1.75rem;
    margin: 2.5rem 0;
    border-radius: 0 8px 8px 0;
    font-style: italic;
    color: var(--color-text);
  }

  /* Code Block Styling */
  .post-content :global(pre) {
    margin: 2rem 0;
    padding: 1.25rem;
    border-radius: 8px;
    border: 1px solid var(--color-border);
    background: var(--color-code-bg);
    position: relative;
  }

  .post-content :global(.copy-code) {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: var(--color-text-muted);
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
    opacity: 0;
  }

  .post-content :global(div:hover > .copy-code),
  .post-content :global(pre:hover .copy-code) {
    opacity: 1;
  }

  .post-content :global(.copy-code:hover) {
    background: var(--color-accent);
    color: white;
    border-color: var(--color-accent);
  }

  /* Author Bio */
  .author-bio {
    margin-top: 5rem;
    padding: 2rem;
    background: var(--color-bg-secondary);
    border-radius: 12px;
    display: flex;
    gap: 1.5rem;
    align-items: center;
    border: 1px solid var(--color-border);
  }

  .bio-avatar {
    width: 64px;
    height: 64px;
    background: var(--gradient-hero);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 800;
    color: white;
    flex-shrink: 0;
  }

  .bio-info h3 {
    margin: 0 0 0.25rem;
    font-size: 1.125rem;
    color: var(--color-text);
  }

  .bio-info p {
    margin: 0;
    color: var(--color-text-secondary);
    font-size: 0.9375rem;
  }

  /* Navigation */
  .post-nav {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-top: 2.5rem;
  }

  .nav-card {
    padding: 1.25rem;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .nav-card:hover {
    border-color: var(--color-accent);
    background: var(--color-bg-secondary);
  }

  .nav-card.empty {
    border: none;
    background: transparent;
    pointer-events: none;
  }

  .nav-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    font-weight: 600;
  }

  .nav-title {
    color: var(--color-text);
    font-weight: 600;
    font-size: 1rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .nav-card.next {
    text-align: right;
  }

  @media (max-width: 1024px) {
    .post-layout {
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .post-sidebar {
      display: none; /* Hide TOC on smaller screens for now, or move to top */
    }
  }

  @media (max-width: 768px) {
    .post-title {
      font-size: 2.25rem;
    }

    .post-nav {
      grid-template-columns: 1fr;
    }

    .nav-card.next {
      text-align: left;
    }
  }
</style>
